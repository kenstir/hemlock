#-----------------------------------------
# SHARED fastlane config
#
# usage: import "../../fastlane/Fastfile"
#-----------------------------------------


#-----------------------------------------
# funcs

# Returns absolute path to repo root
def get_repo_root
  File.expand_path("..", __dir__)
end

def find_aab_for(project)
  repo_root = get_repo_root()
  aab = Dir.glob("#{repo_root}/#{project}/build/outputs/bundle/release/*_app-release.aab").first
  UI.user_error!("No such file: #{repo_root}/#{project}/build/outputs/bundle/release/*_app-release.aab") unless aab
  aab
end

# Returns full path to the current project's AAB
def find_aab
  find_aab_for(get_project())
end

# Returns name of the current project, e.g. "hemlock_app"
# (curiously one level up from the project's Fastfile)
def get_project
  File.basename(File.expand_path("..", Dir.pwd))
end

def increment_version_code(path = "../version.gradle")
  content = File.read(path)

  new_content = content.gsub(/(globalVersionCode = *)(\d+)/) do
    prefix = Regexp.last_match(1)
    number = Regexp.last_match(2).to_i + 1
    "#{prefix}#{number}"
  end

  File.write(path, new_content)
end

def increment_version_string(part = :patch, path = "../version.gradle")
  content = File.read(path)

  new_content = content.gsub(/(VersionName\s*=\s*")(\d+)\.(\d+)\.(\d+)(")/) do
    prefix = Regexp.last_match(1)
    major  = Regexp.last_match(2).to_i
    minor  = Regexp.last_match(3).to_i
    patch  = Regexp.last_match(4).to_i
    suffix = Regexp.last_match(5)

    case part.to_sym
    when :major
      major += 1
      minor = 0
      patch = 0
    when :minor
      minor += 1
      patch = 0
    when :patch
      patch += 1
    else
      raise ArgumentError, "part must be :major, :minor, or :patch"
    end

    "#{prefix}#{major}.#{minor}.#{patch}#{suffix}"
  end

  File.write(path, new_content)
end

#-----------------------------------------
# lanes

desc "Run all the tests"
lane :test do
  Dir.chdir("..") do
    sh("bash ./tools/jdkrun.sh ./gradlew test")
    sh("bash ./tools/jdkrun.sh ./gradlew connectedAndroidTest")
  end
end

desc "Dump vars for testing"
lane :dumpvars do
  repo_root = get_repo_root()
  UI.message("repo_root:   #{repo_root}")

  project = get_project()
  UI.message("project:     #{project}")

  aab = find_aab()
  UI.message("aab:         #{aab}")

  ENV.each do |key, value|
    UI.message("   #{key}=#{value}")
  end
end

desc "Create a release AAB"
lane :make_release do
  project = get_project()
  # 2025-12-01: ../gradlew bundleRelease fails for acorn,cwmars
  #             but ./gradlew :cwmars:bundleRelease works
  Dir.chdir("../..") do
    sh("bash ./tools/jdkrun.sh ./gradlew :#{project}:bundleRelease")
  end
end

desc "Upload release AAB to the open testing channel"
lane :upload_beta do
  upload_to_play_store(
    aab: find_aab(),
    track: "beta",
    release_status: "completed",
    skip_upload_metadata: true,
    skip_upload_changelogs: false,
    skip_upload_images: true,
    skip_upload_screenshots: true
  )
end

desc "Make release AAB + upload to the open testing channel"
lane :beta do
  make_release
  upload_beta
end

lane :bump_version_major do
  increment_version_string(:major)
end

lane :bump_version_minor do
  increment_version_string(:minor)
end

lane :bump_version_patch do
  increment_version_string(:patch)
end

lane :bump_version_code do
  increment_version_code
end
